<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Controllo Telescopio</title>
    <script src="https://telescope.alessiobellino.com/stellarium-web-engine.js"></script>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://npmcdn.com/flatpickr/dist/themes/dark.css"
    />

    <link rel="stylesheet" href="telescope/telescope.css" />
    <link rel="stylesheet" href="telescope/Slider/slider.css" />
    <link rel="stylesheet" href="telescope/Zoom/zoom.css" />
    <link rel="stylesheet" href="telescope/Menu/menu.css" />
    <link rel="stylesheet" href="telescope/Menu/Location/location.css" />
    <link rel="stylesheet" href="telescope/Menu/DateTime/datetime.css" />
    <link rel="stylesheet" href="telescope/Menu/Seeing/seeing.css" />
    <link rel="stylesheet" href="telescope/calendar.css" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link rel="stylesheet" href="util/Control.Geocoder.css" />
    <link rel="stylesheet" href="util/L.Control.Range.css" />
  </head>

  <body>
    <script src="https://app.protobject.com/framework/p.js"></script>
    <script src="config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- <script src="data/locations/cities.js"></script> -->
    <script src="https://unpkg.com/three"></script>
    <script src="https://unpkg.com/globe.gl"></script>

    <!-- Start screen -->
    <div id="startContainer" class="main-container">
      <!-- Header -->
      <section class="header">
        <button class="image-button menu-image" onclick="openMenu()"></button>
        <div class="header-container">
          <button
            id="modeButton"
            class="image-button simple-mode-image advanced-mode-image"
            onclick="toggleMode()"
          ></button>
        </div>
      </section>

      <!-- Mode Content -->
      <section id="modeContent" class="container"></section>
    </div>

    <!-- Menu -->
    <div id="menuContainer" class="main-container">
      <section class="header">
        <button class="image-button close-image" onclick="closeMenu()"></button>
        <div class="header-container">
          <button class="button" onclick="displayMap(event)">
            <p>Mapa</p>
            <i class="fa fa-caret-down" aria-hidden="true"></i>
          </button>
          <button class="button" onclick="displayGlobe(event)">
            <p>Globo</p>
            <i class="fa fa-caret-down" aria-hidden="true"></i>
          </button>
          <button class="button" onclick="displayDateTime(event)">
            <p>Fecha y Tiempo</p>
            <i class="fa fa-caret-down" aria-hidden="true"></i>
          </button>
          <button class="button" onclick="displaySeeingOptions(event)">
            <p>Vista</p>
            <i class="fa fa-caret-down" aria-hidden="true"></i>
          </button>
        </div>
      </section>

      <!-- Option Interaction -->
      <section id="menuInteractionSection">
        <section id="mainMenuSection" class="grid-container active">
          <!-- Stellarium Options -->
          <div id="stellariumOptionsContainer" class="grid-container">
            <button name="constellations" class="image-button stel-button">
              <div class="image-button constellations-image"></div>
              <p>Constelaciones</p>
            </button>
            <button name="atmosphere" class="image-button stel-button active">
              <div class="image-button atmosphere-image"></div>
              <p>Atmosfera</p>
            </button>
            <button name="landscape" class="image-button stel-button active">
              <div class="image-button landscape-image"></div>
              <p>Terreno</p>
            </button>
            <button name="azimuthal" class="image-button stel-button">
              <div class="image-button azimuthal-image"></div>
              <p>Azimuthal</p>
            </button>
            <button name="equatorial" class="image-button stel-button">
              <div class="image-button equatorial-image"></div>
              <p>Equatorial</p>
            </button>
            <button name="dss" class="image-button stel-button">
              <div class="image-button nebulae-image"></div>
              <p>Nebulosa</p>
            </button>
          </div>

          <!-- Pollution -->
          <div id="pollutionSection" class="container">
            <p>Contaminacion Luminica</p>
            <div style="display: flex; justify-content: center">
              <input
                id="autoPollutionCheckbox"
                type="checkbox"
                onclick="autoPollution()"
              />
              <p>Automatica</p>
            </div>
            <div class="slider-container">
              <input
                id="pollutionSlider"
                class="slider h-slider"
                type="range"
                min="1"
                max="9"
                value="9"
              />
            </div>
          </div>
        </section>
        <section id="interactionSection"></section>
      </section>
    </div>

    <!-- Variables - Parameters - Constants -->
    <script src="limit_mag/params.js"></script>
    <script src="telescope/utils/values.js"></script>
    <script src="telescope/Modes/Simple/index.js"></script>
    <script src="telescope/Modes/Advanced/index.js"></script>

    <script>
      modeContainer.innerHTML = simpleModeContent + advancedModeContent;

      const blurSlider = document.getElementById("focusSlider");
      const zoomSlider = document.getElementById("zoomSlider");

      const simpleModeElement = document.getElementById("simpleMode");
      const advancedModeElement = document.getElementById("advancedMode");

      if (modes.simple === true) {
        simpleModeElement.classList.toggle("active");
        modeButtonElement.classList.toggle("simple-mode-image");
      } else {
        advancedModeElement.classList.toggle("active");
        modeButtonElement.classList.toggle("advanced-mode-image");
        enableFinderMode();
      }
      function fixTime(values) {
        engineUTC = values.engineUTC;
      }
    </script>

    <script src="https://unpkg.com/browser-geo-tz@latest/dist/geotz.js"></script>

    <script src="telescope/utils/tz.js"></script>
    <script src="telescope/utils/updateDisplay.js"></script>
    <script src="telescope/utils/lp/pako_inflate.min.js"></script>
    <script src="telescope/utils/lp/getLpFromCoords.js"></script>

    <script src="telescope/Menu/menu.js"></script>
    <script src="telescope/Menu/DateTime/datetime.js"></script>
    <script src="telescope/Menu/Location/location.js"></script>
    <script src="telescope/Menu/Location/globe.js"></script>
    <script src="telescope/Menu/Seeing/seeing.js"></script>
    <script src="telescope/Menu/Pollution/pollution.js"></script>

    <script src="telescope/utils/protobject.js"></script>
    <script src="telescope/utils/luxon.js"></script>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="util/Control.Geocoder.js"></script>
    <script src="util/L.Control.Range.js"></script>

    <script>
      const stellariumOptionButtons = document.querySelectorAll(
        "#stellariumOptionsContainer button"
      );

      stellariumOptionButtons.forEach((btn) => {
        btn.onclick = () => {
          const info = BUTTONS[btn.name];
          Protobject.Core.send({
            msg: "stellariumOption",
            values: { path: info.path, attr: info.attr },
          }).to("index.html");
          btn.classList.toggle("active");
        };
      });

      function toggleMode() {
        simpleModeElement.classList.toggle("active");
        advancedModeElement.classList.toggle("active");
        modeButtonElement.classList.toggle("simple-mode-image");
        modeButtonElement.classList.toggle("advanced-mode-image");
        for (let mode in modes) {
          modes[mode] = !modes[mode];
        }
      }

      function enableFinderMode() {
        if (advancedModeWarningText === undefined) {
          advancedModeWarningText = document.querySelector(
            "#advancedMode .alert-text"
          );
        }
        const buttons = document.querySelectorAll("#lensContainer button");

        advancedModeWarningText.style.opacity = 1;
        buttons.forEach((btn) => {
          btn.disabled = true;
        });
      }

      function disableFinderMode() {
        if (advancedModeWarningText === undefined) {
          advancedModeWarningText = document.querySelector(
            "#advancedMode .alert-text"
          );
        }
        advancedModeWarningText.style.opacity = 0;

        const buttons = document.querySelectorAll("#lensContainer button");

        buttons.forEach((btn) => {
          btn.disabled = false;
        });
      }

      function updateBlur(direction = 1) {
        currentBlur += direction * 0.001;
        currentBlur = Math.max(0, Math.min(10, currentBlur));

        updateDisplayBlur();
      }

      function autoPollution() {
        if (autoPollutionCheckbox.checked == true) {
          pollutionInput.style.opacity = 0;
          pollutionInput.style.pointerEvents = "none";
        } else {
          pollutionInput.style.opacity = 1;
          pollutionInput.style.pointerEvents = "auto";
        }
      }
    </script>

    <script src="limit_mag/limit_magnitude.js"></script>
    <script src="util/time.js"></script>
    <script src="util/overlay.js"></script>
    <script src="util/location.js"></script>
    <script src="util/stel.js"></script>

    <!-- Init stellarium web engine -->
    <script src="util/initStel.js"></script>
    <script>
      initializeStelEngine((isTelescope = true));
    </script>

    <script>
      blurSlider.value = currentBlur;
      updateDisplayFov();
    </script>

    <script src="telescope/Slider/slider.js"></script>
    <script src="telescope/Zoom/zoom.js"></script>

    <script>
      function unwrapAngle(newAngle, prevAngle) {
        let delta = newAngle - prevAngle;
        if (delta > Math.PI) delta -= 2 * Math.PI;
        if (delta < -Math.PI) delta += 2 * Math.PI;
        return prevAngle + delta;
      }

      const Orientation = {
        oldX: null,
        oldY: null,
        start(freq = 200) {
          this.freq = freq;
          this.initSensors();
        },
        initSensors() {
          if ("AbsoluteOrientationSensor" in window) {
            try {
              const sensor = new AbsoluteOrientationSensor({ frequency: 60 });
              sensor.addEventListener("reading", () =>
                this.calculateOrientation(sensor.quaternion)
              );
              sensor.start();
            } catch (error) {
              console.error("Sensor error:", error);
            }
          } else {
            console.error("AbsoluteOrientationSensor non supportato.");
          }
        },
        calculateOrientation(q) {
          if (!q) return;
          const [x, y, z, w] = q;
          const pitch = Math.atan2(
            2 * (w * x + y * z),
            1 - 2 * (x * x + y * y)
          );
          const yaw = Math.atan2(2 * (w * z + x * y), 1 - 2 * (y * y + z * z));

          const fov = Math.exp(logFov);
          const sensitivity = Math.min(1, fov / 20);

          if (this.oldX === null || this.oldY === null) {
            this.oldX = yaw;
            this.oldY = pitch;
          }

          const adjustedYaw = unwrapAngle(yaw, this.oldX);

          this.oldX += (adjustedYaw - this.oldX) * sensitivity;
          this.oldY += (pitch - this.oldY) * sensitivity;

          Protobject.Core.send({
            msg: "updateView",
            values: { h: this.oldX, v: this.oldY },
          }).to("index.html");
          updateStellariumView({ h: this.oldX, v: this.oldY }); //para guia
        },
      };

      Orientation.start();
    </script>
  </body>
</html>
