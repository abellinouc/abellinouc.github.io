<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Controllo Orientamento e FOV</title>

  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
  />

  <link rel="stylesheet" href="telescope/telescope.css">
  <link rel="stylesheet" href="telescope/Slider/slider.css">
  <link rel="stylesheet" href="telescope/Zoom/zoom.css">
  <link rel="stylesheet" href="telescope/Menu/menu.css">
  <link rel="stylesheet" href="telescope/Menu/Location/location.css">
  <link rel="stylesheet" href="telescope/Menu/DateTime/datetime.css">
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <link rel="stylesheet" href="Menu/Mapa/src/Control.Geocoder.css" />
  <link rel="stylesheet" href="telescope/Menu/Mapa/src/L.Control.Range.css" />
</head>

<body>
  <script src="https://app.protobject.com/framework/p.js"></script>
  <script src="config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="data/locations/cities.js"></script>

  <!-- Start screen -->
  <div id="startContainer" class="main-container">

    <!-- Header -->
    <section class="header">
      <button 
        class="image-button menu-image"
        onclick="openMenu()">
      </button>
      <div class="header-container">
        <button id="modeButton" class="image-button simple-mode-image advanced-mode-image" onclick="toggleMode()"></button>
      </div>
    </section>

    <!-- Mode Content -->
    <section id="modeContent" class="container"></section>
  </div>


  <!-- Menu -->
  <div id="menuContainer" class="main-container">
    <section class="header">
      <button 
        class="image-button close-image"
        onclick="closeMenu()">
      </button>
      <div class="header-container">
        <button class="button active" onclick="displayMainMenu(event)">Inicio</button>
        <button class="button" onclick="displayLocation(event)">Ubicacion</button>
        <button class="button" onclick="displayDateTime(event)">Fecha y Tiempo</button>
      </div>
    </section>

    <!-- Option Interaction -->
    <section id="interactionSection">
      <section id="mainMenuSection" class="grid-container active">

        <!-- Stellarium Options -->
        <div id="stellariumOptionsContainer" class="grid-container">
          <button name="constellations" class="image-button constellations-image stel-button active"></button>
          <button name="atmosphere" class="image-button atmosphere-image stel-button active"></button>
          <button name="landscape" class="image-button landscape-image stel-button active"></button>
          <button name="azimuthal" class="image-button azimuthal-image stel-button"></button>
          <button name="equatorial" class="image-button equatorial-image stel-button"></button>
          <button name="nebulae" class="image-button nebulae-image stel-button"></button>
        </div>

        <!-- Pollution -->
        <div id="pollutionSection" class="container">
          <p>Contaminacion Luminica</p>
          <div>
            <input
            type="checkbox">
            <p>Automatica</p>
          </div>
          <input 
            id="pollutionSlider"
            class="slider h-slider"
            type="range" 
            min=1 max=9 value=9>
          </input>
        </div>
      </section>
    </section>
  </div>
  

  <!-- Variables - Parameters - Constants -->
  <script src="telescope/utils/values.js"></script>
  <script src="telescope/Modes/Simple/index.js"></script>
  <script src="telescope/Modes/Advanced/index.js"></script>

  <script>
    modeContainer.innerHTML = simpleModeContent + advancedModeContent;

    const blurSlider = document.getElementById('focusSlider');
    const zoomSlider = document.getElementById('zoomSlider');
    
    const simpleModeElement = document.getElementById('simpleMode');
    const advancedModeElement = document.getElementById('advancedMode');

    if (modes.simple === true) {
      simpleModeElement.classList.toggle('no-display');
      modeButtonElement.classList.toggle('simple-mode-image');
    }
    else {
      advancedModeElement.classList.toggle('no-display');
      modeButtonElement.classList.toggle('advanced-mode-image');
    }
  </script>

<script src="http://unpkg.com/browser-geo-tz@latest/dist/geotz.js"></script>
  <script src="telescope/utils/tz.js"></script>

  <script src="telescope/utils/updateDisplay.js"></script>
  <script src="telescope/utils/lp/pako_inflate.min.js"></script>
  <script src="telescope/utils/lp/getLpFromCoords.js"></script>
  <script src="telescope/Menu/menu.js"></script>
  <script src="telescope/Menu/DateTime/datetime.js"></script>
  <script src="telescope/Menu/Location/location.js"></script>
  <script src="telescope/Menu/Pollution/pollution.js"></script>
  <script src="telescope/utils/protobject.js"></script>
  <script src="telescope/utils/luxon.js"></script>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="telescope/Menu/Mapa/src/Control.Geocoder.js"></script>
  <script src="telescope/Menu/Mapa/src/L.Control.Range.js"></script>
  <script src="telescope/Menu/Mapa/src/pako_inflate.min.js"></script>
  


  <script>
    const stellariumOptionButtons = document.querySelectorAll(
      '#stellariumOptionsContainer button'
    )

    stellariumOptionButtons.forEach( btn => {
      btn.onclick = () => {
        const info = BUTTONS[btn.name];
        Protobject.Core.send({ optionInfo: info }).to("index.html");
        btn.classList.toggle('active');
      }
    })

    function toggleMode() {
      simpleModeElement.classList.toggle('no-display');
      advancedModeElement.classList.toggle('no-display');
      modeButtonElement.classList.toggle('simple-mode-image');
      modeButtonElement.classList.toggle('advanced-mode-image');
    }

    function updateBlur(direction = 1) {
      currentBlur += direction * 0.001;
      currentBlur = Math.max(0, Math.min(10, currentBlur));

      updateDisplayBlur();
    }    
  </script>
    
  <script>
    blurSlider.value = currentBlur;
    updateDisplayFov();
  </script>

  <script src="telescope/Slider/slider.js"></script>
  <script src="telescope/Zoom/zoom.js"></script>

  <script>
    function unwrapAngle(newAngle, prevAngle) {
      let delta = newAngle - prevAngle;
      if (delta > Math.PI) delta -= 2 * Math.PI;
      if (delta < -Math.PI) delta += 2 * Math.PI;
      return prevAngle + delta;
    }

    const Orientation = {
      oldX: null,
      oldY: null,
      start(freq = 200) {
        this.freq = freq;
        this.initSensors();
      },
      initSensors() {
        if ("AbsoluteOrientationSensor" in window) {
          try {
            const sensor = new AbsoluteOrientationSensor({ frequency: 60 });
            sensor.addEventListener("reading", () =>
              this.calculateOrientation(sensor.quaternion)
            );
            sensor.start();
          } catch (error) {
            console.error("Sensor error:", error);
          }
        } else {
          console.error("AbsoluteOrientationSensor non supportato.");
        }
      },
      calculateOrientation(q) {
        if (!q) return;
        const [x, y, z, w] = q;
        const pitch = Math.atan2(
          2 * (w * x + y * z),
          1 - 2 * (x * x + y * y)
        );
        const yaw = Math.atan2(2 * (w * z + x * y), 1 - 2 * (y * y + z * z));

        const fov = Math.exp(logFov);
        const sensitivity = Math.min(1, fov / 20);

        if (this.oldX === null || this.oldY === null) {
          this.oldX = yaw;
          this.oldY = pitch;
        }

        const adjustedYaw = unwrapAngle(yaw, this.oldX);

        this.oldX += (adjustedYaw - this.oldX) * sensitivity;
        this.oldY += (pitch - this.oldY) * sensitivity;

        Protobject.Core.send({ h: this.oldX, v: this.oldY }).to("index.html");
      },
    };

    Orientation.start();
  </script>
</body>
</html>
