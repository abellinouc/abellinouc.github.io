<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Stellarium Web Engine</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
    <link rel="stylesheet" href="stellarium.styles.css" />
    
    <style>
      #modal-container::-webkit-scrollbar {
        display: none;
      }
    </style>
  </head>
  <body>
    <script src="https://app.protobject.com/framework/p.js"></script>
    <script src="config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://telescope.alessiobellino.com/stellarium-web-engine.js"></script>
    <script src="util/lp/pako_inflate.min.js"></script>
    <script src="util/lp/getLpFromCoords.js"></script>
    <script src="data/locations/cities.js"></script>

    <div class="topbar">
      <span class="title">Stellarium<sup>Web</sup></span>
      <div id="progress"></div>
    </div>

    <div id="stel">
      <canvas id="stel-canvas"></canvas>
      <div id="info-card"></div>
    </div>

    <div class="footer" id="footer-buttons"></div>
    <div id="modal-container"></div>

    <script src="util/protobject.js"></script>
    <script>
      let datetimeInterval = null;

      const BUTTONS = [
        {
          label: "Constellations",
          img: "https://telescope.alessiobellino.com/svg/btn-cst-lines.svg",
          path: "constellations",
          attr: "lines_visible",
        },
        {
          label: "Atmosphere",
          img: "https://telescope.alessiobellino.com/svg/btn-atmosphere.svg",
          path: "atmosphere",
          attr: "visible",
        },
        {
          label: "Landscape",
          img: "https://telescope.alessiobellino.com/svg/btn-landscape.svg",
          path: "landscapes",
          attr: "visible",
        },
        {
          label: "Azimuthal Grid",
          img: "https://telescope.alessiobellino.com/svg/btn-azimuthal-grid.svg",
          path: "lines.azimuthal",
          attr: "visible",
        },
        {
          label: "Equatorial Grid",
          img: "https://telescope.alessiobellino.com/svg/btn-equatorial-grid.svg",
          path: "lines.equatorial",
          attr: "visible",
        },
        {
          label: "Nebulae",
          img: "https://telescope.alessiobellino.com/svg/btn-nebulae.svg",
          path: "dsos",
          attr: "visible",
        },
        {
          label: "DSS",
          img: "https://telescope.alessiobellino.com/svg/btn-nebulae.svg",
          path: "dss",
          attr: "visible",
        },
        {
          label: "Pollution",
          img: "https://telescope.alessiobellino.com/svg/btn-pollution.svg",
          path: "pollution",
          attr: "visible",
        },
      ];

      const canvas_blur = document.getElementById("stel-canvas");

      function toJulianDateIso(iso) {
        const now = new Date(iso);
        const jd = now.getTime() / 86400000 + 2440587.5; // Julian Date
        const mjd = jd - 2400000.5; // Modified Julian Date
        return mjd;
      }

      function updateStellariumView(data) {
        if (!engine?.core?.observer) return;
        engine.core.observer.yaw = -data.h;
        engine.core.observer.pitch = data.v;
      }

      function updateStellariumFov(fov) {
        if (!engine?.core) return;
        engine.core.fov = fov;
      }

      function updateStellariumBlur(blur) {
        canvas_blur.style.filter = `blur(${blur}px)`;
      }

      function toggleEyepieceOverlay() {
        const overlay = document.getElementById("eyepiece-overlay");
        if (overlay) {
          overlay.remove();
        } else {
          const newOverlay = document.createElement("div");
          newOverlay.id = "eyepiece-overlay";
          newOverlay.style.position = "absolute";
          newOverlay.style.top = "0";
          newOverlay.style.left = "0";
          newOverlay.style.width = "100%";
          newOverlay.style.height = "100%";
          newOverlay.style.pointerEvents = "none";
          newOverlay.style.backgroundColor = "transparent";
          newOverlay.style.backgroundImage =
            "radial-gradient(circle at center, transparent 35%, black 40%)";
          newOverlay.style.backgroundSize = "100% 100%";
          newOverlay.style.backgroundRepeat = "no-repeat";
          newOverlay.style.backgroundPosition = "center";
          document.body.appendChild(newOverlay);
        }
      }

      let flatpickrSyncInterval = null;
      let activeFlatpickr = null;
      let isUserTouchingCalendar = false;
      let lastManualChange = 0;

      StelWebEngine({
        wasmFile:
          "https://telescope.alessiobellino.com/stellarium-web-engine.wasm",
        canvas: document.getElementById("stel-canvas"),
        onReady(stel) {
          engine = stel;
          const core = stel.core;

          core.observer.utc = toJulianDateIso(new Date().toISOString());
          core.observer.latitude = -33.4489 * (Math.PI / 180);
          core.observer.longitude = -70.6693 * (Math.PI / 180);
          core.observer.elevation = 570;
          core.observer.name = "Santiago, Chile";

          const baseUrl =
            "https://telescope.alessiobellino.com/stardata/cache/";

          core.stars.addDataSource({
            url:
              baseUrl +
              "swe-data-packs/minimal/2020-09-01/minimal_2020-09-01_186e7ee2/stars",
            key: "minimal",
          });
          core.stars.addDataSource({
            url:
              baseUrl +
              "swe-data-packs/base/2020-09-01/base_2020-09-01_1aa210df/stars",
            key: "base",
          });
          core.stars.addDataSource({
            url:
              baseUrl +
              "swe-data-packs/extended/2020-03-11/extended_2020-03-11_26aa5ab8/stars",
            key: "extended",
          });
          core.stars.addDataSource({
            url: baseUrl + "surveys/gaia/v1",
            key: "gaia",
          });

          core.skycultures.addDataSource({
            url: baseUrl + "skycultures/v3/western",
            key: "western",
          });
          core.dsos.addDataSource({
            url:
              baseUrl +
              "swe-data-packs/base/2020-09-01/base_2020-09-01_1aa210df/dso",
          });
          core.dsos.addDataSource({
            url:
              baseUrl +
              "swe-data-packs/extended/2020-03-11/extended_2020-03-11_26aa5ab8/dso",
          });

          core.landscapes.addDataSource({
            url: baseUrl + "landscapes/v1/guereins",
            key: "guereins",
          });
          core.milkyway.addDataSource({ url: baseUrl + "surveys/milkyway/v1" });
          core.dss.addDataSource({ url: baseUrl + "surveys/dss/v1" });
          core.minor_planets.addDataSource({
            url: baseUrl + "mpc/v1/mpcorb.dat",
            key: "mpc_asteroids",
          });
          core.comets.addDataSource({
            url: baseUrl + "mpc/v1/CometEls.txt?v=2019-12-17",
            key: "mpc_comets",
          });
          core.satellites.addDataSource({
            url: baseUrl + "skysources/v1/tle_satellite.jsonl.gz?v=2019-09-16",
            key: "jsonl/sat",
          });

          [
            "moon",
            "sun",
            "jupiter",
            "mercury",
            "venus",
            "mars",
            "saturn",
            "uranus",
            "neptune",
            "io",
            "europa",
            "ganymede",
            "callisto",
            "moon-normal",
          ].forEach((p) => {
            core.planets.addDataSource({
              url: baseUrl + `surveys/sso/${p}/v1`,
              key: p,
            });
          });

          const footer = document.getElementById("footer-buttons");
          BUTTONS.forEach(({ label, img, path, attr }) => {
            const btn = document.createElement("div");
            btn.className = "stel-button";
            btn.innerHTML = `<img src="${img}" title="${label}" />`;
            // Custom pollution overlay
            if (label === "Pollution") {
              btn.onclick = () => {
                let overlay = document.getElementById("pollution-overlay");
                const isActive = btn.classList.toggle("active");
                if (isActive) {
                  if (!overlay) {
                    overlay = document.createElement("div");
                    overlay.id = "pollution-overlay";
                    overlay.style.position = "absolute";
                    overlay.style.top = 0;
                    overlay.style.left = 0;
                    overlay.style.width = "100%";
                    overlay.style.height = "100%";
                    overlay.style.pointerEvents = "none";
                    overlay.style.zIndex = 5;
                    const stel = document.getElementById("stel");
                    stel.appendChild(overlay);
                  }
                  overlay.style.display = "block";
                  updatePollutionOverlay();
                  if (pollutionOverlayTimer)
                    clearInterval(pollutionOverlayTimer);
                  pollutionOverlayTimer = setInterval(
                    () => updatePollutionOverlay(),
                    1000
                  );
                } else {
                  if (overlay) {
                    overlay.style.opacity = 0;
                    setTimeout(() => {
                      overlay.style.display = "none";
                    }, 1000);
                  }
                  if (pollutionOverlayTimer) {
                    clearInterval(pollutionOverlayTimer);
                    pollutionOverlayTimer = null;
                  }
                  if (overlay) {
                    overlay.style.opacity = 0;
                    setTimeout(() => {
                      overlay.style.display = "none";
                    }, 1000);
                  }

                  if (engine.core) {
                    engine.core.bortle_index = 1;
                    engine.core.display_limit_mag = 7.5;
                    engine.core.star_relative_scale = 1.1;
                    engine.core.star_linear_scale = 0.8;
                  }
                }
              };
            } else {
              btn.onclick = () => {
                const obj = path.split(".").reduce((o, k) => o && o[k], core);
                if (obj) {
                  obj[attr] = !obj[attr];
                  btn.classList.toggle("active", obj[attr]);
                }
              };
            }
            footer.appendChild(btn);
          });

          stel.change((obj, attr) => {
            if (attr === "hovered") return;

            const info = document.getElementById("info-card");
            if (stel.core.selection) {
              const s = stel.core.selection;
              const name = s.designations()[0].replace(/^NAME /, "");
              const radec = stel.convertFrame(
                core.observer,
                "ICRF",
                "CIRS",
                s.getInfo("radec")
              );
              const coords = stel.c2s(radec);
              const ra = stel.anp(coords[0]);
              const dec = stel.anpm(coords[1]);
              const mag = s.getInfo("vmag");
              info.innerHTML = `
              <h3>${name}</h3>
              <p><strong>Magnitude:</strong> ${
                mag !== undefined ? mag.toFixed(2) : "Unknown"
              }</p>
              <p><strong>Ra:</strong> ${ra.toFixed(3)}</p>
              <p><strong>Dec:</strong> ${dec.toFixed(3)}</p>`;
              info.style.display = "block";
            } else {
              info.style.display = "none";
            }

            const progress = core.progressbars[0];
            if (progress) {
              document.getElementById("progress").innerText = `${
                progress.label
              }: ${((progress.value / progress.total) * 100).toFixed(0)}%`;
            }
          });
        },
      });

      let clockInterval = null;
      let timeSpeed = 0;
      let suppressFlatpickrUpdate = false;

      function setSpeed(multiplier) {
        timeSpeed = multiplier;

        if (clockInterval) {
          clearInterval(clockInterval);
          clockInterval = null;
        }

        if (multiplier > 0) {
          clockInterval = setInterval(() => {
            if (!engine) return;
            const simulatedSecondsPerStep = multiplier * 0.03; // 30 ms
            const jdStep = simulatedSecondsPerStep / 86400;
            engine.core.observer.utc += jdStep;
          }, 30);
        }

        // updateSpeedButtons(); // ← Aggiorna subito la UI dei bottoni
      }

      function updateDate(date) {
        engine.core.observer.utc = date;
      }

      function setDatetimeInterval() {
        datetimeInterval = setInterval(() => {
          Protobject.Core.send({ engineUTC: engine.core.observer.utc }).to("telescope.html")
        }, 300)
      }

      function clearDatetimeInterval() {
        clearInterval(datetimeInterval);
      }
    </script>
    <script>
      let selectedCity = "Santiago"; // valor por defecto (Santiago, Chile)

      let cities = cities_data;

      // fetch("data/cities.json")
      //   .then((response) => {
      //     if (!response.ok) {
      //       throw new Error("No se pudo cargar el archivo JSON");
      //     }
      //     return response.json();
      //   })
      //   .then((data) => {
      //     cities = data;
      //     //console.log("Ciudades cargadas:", cities);

      //     //console.log("Datos de la ciudad seleccionada:", cities[selectedCity]);
      //   })
      //   .catch((error) => {
      //     console.error("Error al cargar el JSON:", error);
      //   });

      function showLocationSelector() {
        const modal = document.getElementById("modal-container");
        const locationBtn = document.querySelector(
          '.control-button[onclick="showLocationSelector()"]'
        );

        const isVisible = modal.style.display === "block";

        if (isVisible) {
          modal.style.display = "none";
          locationBtn.classList.remove("active");
          return;
        }

        let buttonsHtml = "<h3>Select Location</h3>";
        for (const city in cities) {
          const isSelected = city === selectedCity;
          buttonsHtml += `
      <button class="control-button" style="
        display: block;
        width: 100%;
        margin-bottom: 0.5rem;
        background-color: ${isSelected ? "#4caf50" : "rgba(255,255,255,0.1)"};
        font-weight: ${isSelected ? "bold" : "normal"};
      " onclick="applyLocation('${city}')">
        ${city}
      </button>`;
        }

        modal.innerHTML = buttonsHtml;
        modal.style.display = "block";
        locationBtn.classList.add("active");
      }

      // Light pollution section

      let pollutionOverlayTimer = null;

      function updatePollutionOverlay(forceHide = false) {
        const overlay = document.getElementById("pollution-overlay");
        if (!overlay) return;

        const city = cities[selectedCity];
        const pollution =
          city && city.contaminacion !== undefined ? city.contaminacion : 1;

        // Mostrar overlay
        overlay.style.transition = "opacity 1s";
        overlay.style.opacity = 0.1 * pollution;
        overlay.style.display = "block";

        // Fondo visual del overlay
        overlay.style.background = `radial-gradient(ellipse at bottom, 
          rgba(255,200,100,${0.02 + 0.06 * (pollution - 1)}) 0%, 
          rgba(255,150,50,${0.015 + 0.045 * (pollution - 1)}) 30%, 
          rgba(200,100,50,${0.01 + 0.03 * (pollution - 1)}) 60%, 
          rgba(100,50,25,${0.005 + 0.015 * (pollution - 1)}) 80%, 
          rgba(0,0,0,0.0) 100%)`;

        // Ajustar parámetros del motor
        if (engine.core) {
          engine.core.bortle_index = pollution; // de 1 a 9
          engine.core.milkyway.visible = pollution < 6;

          // Magnitud límite: de 7.5 (cielo oscuro) a 1.0 (ciudad)
          engine.core.display_limit_mag = 7.5 - 0.8 * (pollution - 1);
          
          // Escala relativa de estrellas: reducir progresivamente
          //engine.core.star_relative_scale = Math.max(0.3, 1.2 - 0.1 * pollution);
          
          // Escala lineal: reducir más agresivamente en ciudades
          
          //engine.core.star_linear_scale = Math.max(0.2, 1.0 - 0.08 * pollution);
        }
      }

      function setSelectedCityWithPollution(city) {
        selectedCity = city;
        // Update overlay if active
        const overlay = document.getElementById("pollution-overlay");
        if (overlay && overlay.style.display !== "none") {
          updatePollutionOverlay();
        }
      }

      async function applyLocation({ cityName, lat, lon, elev }) {
        const data = cityName 
          ? cities[cityName]
          : (lat || lat == 0) && (lon || lon == 0) 
            ? { lat, lon, elev }
            : null;
        if (!data || !engine) return;

        const latLon = {lat: data.lat, lng: data.lon};

        engine.core.observer.latitude = data.lat * (Math.PI / 180);
        engine.core.observer.longitude = data.lon * (Math.PI / 180);
        engine.core.observer.elevation = data.elev || 0;
        engine.core.observer.name = cityName || 'Custom';

        // Apply this only to custom locations
        const bortle_index = await getBortleIndex(latLon);

        console.log("Bortle index for", cityName, ":", bortle_index);

        const localTime = new Date();
        engine.core.observer.utc = toJulianDateIso(localTime.toISOString());
        engine.core.observer.pitch = 0;
        engine.core.observer.yaw = 0;

        setSelectedCityWithPollution(cityName || 'Custom'); // APLICAR POLLUTION PERSONALIZADA
        // showLocationSelector();
      }

      function updateSpeedButtons() {
        document
          .querySelectorAll("#modal-container .control-button")
          .forEach((btn) => {
            const text = btn.textContent.trim();

            const match =
              (timeSpeed === 0 && text.startsWith("🟥")) ||
              (timeSpeed === 1 && text.startsWith("🕒")) ||
              (timeSpeed === 10 && text.includes("10x")) ||
              (timeSpeed === 60 && text.includes("60x")) ||
              (timeSpeed === 3600 && text.includes("3600x"));

            btn.classList.toggle("active", match);
          });
      }

      function fromJulianDateToDate(jd) {
        return new Date((jd - 2440587.5) * 86400000);
      }

      function fromMJDToDate(mjd) {
        const jd = mjd + 2400000.5;
        return new Date((jd - 2440587.5) * 86400000);
      }

      function showTimeSelector() {
        const modal = document.getElementById("modal-container");
        const timeBtn = document.querySelector(
          '.control-button[onclick="showTimeSelector()"]'
        );
        const isVisible = modal.style.display === "block";

        if (isVisible) {
          modal.style.display = "none";
          timeBtn.classList.remove("active");

          if (flatpickrSyncInterval) {
            clearInterval(flatpickrSyncInterval);
            flatpickrSyncInterval = null;
          }

          return;
        }

        modal.innerHTML = `
    <h3>Select Date & Time</h3>
    <div id="datetime-picker" style="margin-bottom: 1rem; width: 100%;"></div>

    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 1rem;">
      <button class="control-button" onclick="setSpeed(0)">🟥 Stop</button>
      <button class="control-button" onclick="setSpeed(1)">🕒 Realtime</button>
      <button class="control-button" onclick="setSpeed(10)">⏩ 10x</button>
      <button class="control-button" onclick="setSpeed(60)">⏩ 60x</button>
      <button class="control-button" onclick="setSpeed(3600)">⏩ 3600x</button>
    </div>
  `;

        activeFlatpickr = flatpickr("#datetime-picker", {
          enableTime: true,
          dateFormat: "Y-m-d\\TH:i:S",
          time_24hr: true,
          defaultDate: new Date(),
          inline: true,
          onOpen: () => (isUserTouchingCalendar = true),
          onClose: () => (isUserTouchingCalendar = false),

          onChange: function (selectedDates) {
            if (selectedDates.length > 0) {
              const date = selectedDates[0];
              lastManualChange = Date.now();
              engine.core.observer.utc = toJulianDateIso(date.toISOString());
            }
          },

          onValueUpdate: function (selectedDates) {
            if (selectedDates.length > 0) {
              const date = selectedDates[0];
              lastManualChange = Date.now();
              engine.core.observer.utc = toJulianDateIso(date.toISOString());
            }
          },

          onMonthChange: function (selectedDates) {
            if (selectedDates.length > 0) {
              const date = selectedDates[0];
              lastManualChange = Date.now();
              engine.core.observer.utc = toJulianDateIso(date.toISOString());
            }
          },

          onYearChange: function (selectedDates) {
            if (selectedDates.length > 0) {
              const date = selectedDates[0];
              lastManualChange = Date.now();
              engine.core.observer.utc = toJulianDateIso(date.toISOString());
            }
          },
        });

        modal.style.display = "block";
        timeBtn.classList.add("active");
        updateSpeedButtons();

        flatpickrSyncInterval = setInterval(() => {
          if (!activeFlatpickr || !engine?.core?.observer?.utc) return;

          const now = Date.now();
          const recentlyChanged = now - lastManualChange < 2000;

          if (!isUserTouchingCalendar && !recentlyChanged) {
            const date = fromMJDToDate(engine.core.observer.utc);
            activeFlatpickr.setDate(date, false);
          }
        }, 300);
      }
    </script>
  </body>
</html>
