<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stellarium Web Engine</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body {
      margin: 0; padding: 0;
      height: 100%; width: 100%;
      font-family: Roboto, sans-serif;
      background-color: #000; color: white;
    }

    .topbar {
      background: rgba(0,0,0,0.5);
      height: 64px;
      display: flex;
      align-items: center;
      padding: 0 1rem;
    }

    .title {
      font-size: 1.5rem;
      font-weight: bold;
      margin-left: 1rem;
    }

    .footer {
      position: fixed;
      bottom: 0;
      width: 100%;
      display: flex;
      justify-content: center;
      background: rgba(0,0,0,0.3);
      padding: 0.5rem;
      gap: 0.5rem;
    }

    .stel-button {
      width: 50px;
      height: 50px;
      opacity: 0.5;
    }

    .stel-button.active {
      opacity: 1;
    }

    .stel-button img {
      width: 100%;
      height: 100%;
    }

    #stel {
      position: absolute;
      top: 64px;
      bottom: 60px;
      left: 0;
      right: 0;
    }

    #stel-canvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    #info-card {
      position: absolute;
      top: 70px;
      left: 10px;
      width: 400px;
      background: rgba(0,0,0,0.6);
      padding: 1rem;
      font-size: 0.9rem;
      display: none;
    }
    .dropdown-menu div{
      color:#000;
    }

    .radecVal { font-family: monospace; font-weight: bold; display: inline-block; margin-right: 5px; }
    .radecUnit { color: #ccc; font-weight: normal; }
  </style>
</head>
<body>
  <script src="https://app.protobject.com/framework/p.js"></script>
  <script src="config.js"></script>
  <script src="https://telescope.alessiobellino.com/stellarium-web-engine.js"></script>

  <div class="topbar">
    <span class="title">Stellarium<sup>Web</sup></span>
    <div id="progress" style="margin-left:auto; margin-right:1rem;"></div>
  </div>

  <div id="stel">
    <canvas id="stel-canvas"></canvas>
    <div id="info-card"></div>
  </div>

  <div class="footer" id="footer-buttons"></div>

  <script>
    const BUTTONS = [
      { label: "Constellations", img: "https://telescope.alessiobellino.com/svg/btn-cst-lines.svg", path: "constellations", attr: "lines_visible" },
      { label: "Atmosphere", img: "https://telescope.alessiobellino.com/svg/btn-atmosphere.svg", path: "atmosphere", attr: "visible" },
      { label: "Landscape", img: "https://telescope.alessiobellino.com/svg/btn-landscape.svg", path: "landscapes", attr: "visible" },
      { label: "Azimuthal Grid", img: "https://telescope.alessiobellino.com/svg/btn-azimuthal-grid.svg", path: "lines.azimuthal", attr: "visible" },
      { label: "Equatorial Grid", img: "https://telescope.alessiobellino.com/svg/btn-equatorial-grid.svg", path: "lines.equatorial", attr: "visible" },
      { label: "Nebulae", img: "https://telescope.alessiobellino.com/svg/btn-nebulae.svg", path: "dsos", attr: "visible" },
      { label: "DSS", img: "https://telescope.alessiobellino.com/svg/btn-nebulae.svg", path: "dss", attr: "visible" },
    ];

    function toJulianDateIso(iso) {
      return new Date(iso).getTime() / 86400000 + 2440587.5;
    }

    function updateStellariumView(data) {
      if (!engine?.core?.observer) return;
      engine.core.observer.yaw = -data.h;
      engine.core.observer.pitch = data.v;
    }

    function updateStellariumFov(fov) {
      if (!engine?.core) return;
      engine.core.fov = fov;
    }

    Protobject.Core.onReceived(data => {
      console.log(data);
      if (data.f) updateStellariumFov(data.f);
      else updateStellariumView(data);
    });

    let engine;
    StelWebEngine({
      wasmFile: 'https://telescope.alessiobellino.com/stellarium-web-engine.wasm',
      canvas: document.getElementById('stel-canvas'),
      onReady(stel) {
        engine = stel;
        const core = stel.core;

        core.observer.utc = toJulianDateIso("2024-06-27T23:15:00Z");
        core.observer.latitude = -33.4489;
        core.observer.longitude = -70.6693;
        core.observer.elevation = 570;
        core.observer.name = "Santiago, Chile";

        const baseUrl = 'https://telescope.alessiobellino.com/stardata/cache/';

        core.stars.addDataSource({ url: baseUrl + "swe-data-packs/minimal/2020-09-01/minimal_2020-09-01_186e7ee2/stars", key: "minimal" });
        core.stars.addDataSource({ url: baseUrl + "swe-data-packs/base/2020-09-01/base_2020-09-01_1aa210df/stars", key: "base" });
        core.stars.addDataSource({ url: baseUrl + "swe-data-packs/extended/2020-03-11/extended_2020-03-11_26aa5ab8/stars", key: "extended" });
        core.stars.addDataSource({ url: baseUrl + "surveys/gaia/v1", key: "gaia" });

        core.skycultures.addDataSource({ url: baseUrl + "skycultures/v3/western", key: "western" });
        core.dsos.addDataSource({ url: baseUrl + "swe-data-packs/base/2020-09-01/base_2020-09-01_1aa210df/dso" });
        core.dsos.addDataSource({ url: baseUrl + "swe-data-packs/extended/2020-03-11/extended_2020-03-11_26aa5ab8/dso" });

        core.landscapes.addDataSource({ url: baseUrl + "landscapes/v1/guereins", key: "guereins" });
        core.milkyway.addDataSource({ url: baseUrl + "surveys/milkyway/v1" });
        core.dss.addDataSource({ url: baseUrl + "surveys/dss/v1" });
        core.minor_planets.addDataSource({ url: baseUrl + "mpc/v1/mpcorb.dat", key: "mpc_asteroids" });
        core.comets.addDataSource({ url: baseUrl + "mpc/v1/CometEls.txt?v=2019-12-17", key: "mpc_comets" });
        core.satellites.addDataSource({ url: baseUrl + "skysources/v1/tle_satellite.jsonl.gz?v=2019-09-16", key: "jsonl/sat" });

        const planets = ["moon", "sun", "jupiter", "mercury", "venus", "mars", "saturn", "uranus", "neptune", "io", "europa", "ganymede", "callisto", "moon-normal"];
        planets.forEach(p => {
          core.planets.addDataSource({ url: baseUrl + `surveys/sso/${p}/v1`, key: p });
        });

        const footer = document.getElementById('footer-buttons');
        BUTTONS.forEach(({ label, img, path, attr }) => {
          const btn = document.createElement('div');
          btn.className = 'stel-button';
          btn.innerHTML = `<img src="${img}" title="${label}" />`;
          btn.onclick = () => {
            const obj = path.split('.').reduce((o, k) => o && o[k], core);
            if (obj) {
              obj[attr] = !obj[attr];
              btn.classList.toggle('active', obj[attr]);
            }
          };
          footer.appendChild(btn);
        });

        stel.change((obj, attr) => {
          if (attr === 'hovered') return;

          const info = document.getElementById('info-card');
          if (stel.core.selection) {
            const s = stel.core.selection;
            const name = s.designations()[0].replace(/^NAME /, '');
            const radec = stel.convertFrame(core.observer, 'ICRF', 'CIRS', s.getInfo('radec'));
            const coords = stel.c2s(radec);
            const ra = stel.anp(coords[0]);
            const dec = stel.anpm(coords[1]);
            const mag = s.getInfo('vmag');
            info.innerHTML = `
              <h3>${name}</h3>
              <p><strong>Magnitude:</strong> ${mag !== undefined ? mag.toFixed(2) : 'Unknown'}</p>
              <p><strong>Ra:</strong> ${ra.toFixed(3)}</p>
              <p><strong>Dec:</strong> ${dec.toFixed(3)}</p>`;
            info.style.display = 'block';
          } else {
            info.style.display = 'none';
          }

          const progress = core.progressbars[0];
          if (progress) {
            document.getElementById('progress').innerText = `${progress.label}: ${(progress.value / progress.total * 100).toFixed(0)}%`;
          }
        });
      }
    });
  </script>
</body>
</html>
