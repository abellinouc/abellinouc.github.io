<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mapa Preciso con ArUco</title>
  </head>
  <body
    style="margin: 0; background: #111; color: white; font-family: sans-serif"
  >
    <script src="https://app.protobject.com/framework/p.js"></script>
    <script src="config.js"></script>
    <script>
      // Dimensiones físicas del mapa (en cm)
      const MAP_WIDTH_CM = 100;
      const MAP_HEIGHT_CM = 70;

      // ID y tamaño real del marcador ArUco
      const TARGET_ID = 8;
      const MARKER_SIZE_CM = 7;

      // Iniciar detección
      Protobject.Aruco.start(1000, 1);

      // Mostrar cámara en pantalla
      Protobject.Aruco.showPreview({
        top: 0,
        left: 0,
        width: window.innerWidth,
        height: window.innerHeight,
      });

      // Función para convertir coordenadas de píxeles a cm dentro del mapa
      function mapToMapCoordinates(x, y, camWidth, camHeight) {
        const normX = x / camWidth;
        const normY = y / camHeight;
        return {
          cmX: normX * MAP_WIDTH_CM,
          cmY: normY * MAP_HEIGHT_CM,
        };
      }

      // Calcular centro del marcador desde sus esquinas
      function getMarkerCenter(corners) {
        const sum = corners.reduce(
          (acc, point) => {
            acc.x += point.x;
            acc.y += point.y;
            return acc;
          },
          { x: 0, y: 0 }
        );
        return {
          x: sum.x / corners.length,
          y: sum.y / corners.length,
        };
      }

      Protobject.Aruco.onData((data) => {
        if (!data.markers || data.markers.length === 0) return;

        // Buscar el marcador con ID específico
        const marker = data.markers.find((m) => m.id === TARGET_ID);
        if (!marker) return;

        // Determinar centro exacto del marcador
        let center;
        if (marker.corners && marker.corners.length === 4) {
          center = getMarkerCenter(marker.corners);
        } else {
          center = { x: marker.x, y: marker.y };
        }

        // Dimensiones de la imagen de detección
        const camWidth = data.size?.width || window.innerWidth;
        const camHeight = data.size?.height || window.innerHeight;

        // Convertir a cm dentro del mapa
        const { cmX, cmY } = mapToMapCoordinates(
          center.x,
          center.y,
          camWidth,
          camHeight
        );

        // Crear objeto de posición
        const position = {
          id: marker.id,
          marker_size_cm: MARKER_SIZE_CM,
          x_cm: parseFloat(cmX.toFixed(2)),
          y_cm: parseFloat(cmY.toFixed(2)),
        };

        console.log("[INFO] Coordenadas precisas:", position);

        // Enviar a index.html
        Protobject.Core.send(position).to("index.html");
      });
    </script>
  </body>
</html>
