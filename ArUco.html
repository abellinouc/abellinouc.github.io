<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Aruco Tracking Control</title>
    <style>
      body {
        margin: 0;
        background: black;
        color: white;
        font-family: sans-serif;
        text-align: center;
      }
      #log {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        max-height: 100px;
        overflow-y: auto;
        background: rgba(0, 0, 0, 0.5);
        color: #fff;
        font-family: monospace;
        font-size: 0.9em;
        padding: 10px;
        box-sizing: border-box;
        text-align: left;
        z-index: 1000;
      }
      .error {
        color: #ff6b6b;
      }
      .warn {
        color: #f1c40f;
      }
      .info {
        color: #00d1b2;
      }
      #controls {
        margin: 10px 0;
      }
      button {
        font-size: 1.2em;
        margin: 0 10px;
        padding: 0.5em 1em;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div id="controls">
      <button id="startBtn">Start Detection</button>
      <button id="stopBtn" disabled>Stop Detection</button>
    </div>

    <div id="log"></div>

    <script src="https://app.protobject.com/framework/p.js"></script>
    <script src="config.js"></script>

    <script>
      const startBtn = document.getElementById("startBtn");
      const stopBtn = document.getElementById("stopBtn");
      const logDiv = document.getElementById("log");

      // IDs marcadores esquinas y telescopio
      const cornerMarkers = {
        topLeft: 0,
        topRight: 1,
        bottomLeft: 2,
        bottomRight: 3,
      };
      const telescopeMarker = 10;

      let detectionActive = false;
      let cameraStarted = false;

      function showMessage(message, type = "info") {
        const entry = document.createElement("div");
        entry.className = type;
        entry.textContent = `[${type.toUpperCase()}] ${message}`;
        logDiv.appendChild(entry);
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      function startCamera() {
        if (cameraStarted) {
          showMessage("Cámara ya iniciada.", "warn");
          return;
        }
        try {
          Protobject.Aruco.start(1000, 1);
          Protobject.Aruco.showPreview({
            top: 55,
            left: 0,
            width: window.innerWidth,
            height: window.innerHeight,
          });
          cameraStarted = true;
          showMessage("Cámara iniciada correctamente.", "info");
        } catch (error) {
          showMessage("Error al iniciar la cámara: " + error.message, "error");
        }
      }

      function startDetection() {
        if (!cameraStarted) {
          startCamera();
        }
        detectionActive = true;
        showMessage("Detección activada.", "info");
        startBtn.disabled = true;
        stopBtn.disabled = false;
      }

      function stopDetection() {
        detectionActive = false;
        showMessage("Detección detenida.", "info");
        startBtn.disabled = false;
        stopBtn.disabled = true;
        // NO detenemos la cámara ni ocultamos la vista previa para que siga activa
      }

      // Escuchar datos de marcadores y procesar solo si detección está activa
      Protobject.Aruco.onData((data) => {
        if (!detectionActive) return;

        try {
          const detectedIDs = Object.keys(data).map((id) => parseInt(id));
          showMessage(
            "Marcadores detectados: " + detectedIDs.join(", "),
            "info"
          );

          const expectedMarkers = [
            cornerMarkers.topLeft,
            cornerMarkers.topRight,
            cornerMarkers.bottomLeft,
            cornerMarkers.bottomRight,
            telescopeMarker,
          ];

          const missingMarkers = expectedMarkers.filter(
            (id) => !detectedIDs.includes(id)
          );

          if (missingMarkers.length > 0) {
            showMessage(
              "Marcadores faltantes: " + missingMarkers.join(", "),
              "warn"
            );
            return;
          }

          showMessage("Todos los marcadores detectados correctamente.", "info");

          const tl = data[cornerMarkers.topLeft].position;
          const tr = data[cornerMarkers.topRight].position;
          const bl = data[cornerMarkers.bottomLeft].position;
          const br = data[cornerMarkers.bottomRight].position;
          const tPos = data[telescopeMarker].position;

          const mapWidth = tr.x - tl.x;
          const mapHeight = bl.y - tl.y;

          if (mapWidth === 0 || mapHeight === 0) {
            showMessage(
              "Dimensiones inválidas del mapa (ancho o alto es 0).",
              "error"
            );
            return;
          }

          const normX = (tPos.x - tl.x) / mapWidth;
          const normY = (tPos.y - tl.y) / mapHeight;

          const lon = -180 + normX * 360;
          const lat = 90 - normY * 180;

          showMessage(
            `Coordenadas enviadas: lat=${lat.toFixed(4)}, lon=${lon.toFixed(
              4
            )}`,
            "info"
          );

          Protobject.Core.send({ h: lon, v: lat }).to("index.html");
        } catch (error) {
          showMessage(
            "Error al procesar datos de Aruco: " + error.message,
            "error"
          );
        }
      });

      startBtn.addEventListener("click", startDetection);
      stopBtn.addEventListener("click", stopDetection);
    </script>
  </body>
</html>
